import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'
import { Task, TaskStep } from '@/types'

interface Params {
  params: Promise<{ id: string }>
}

export async function PUT(request: Request, { params }: Params) {
  try {
    const supabase = await createClient()
    const { id: taskId } = await params

    // ì¸ì¦ í™•ì¸
    const { data: { user }, error: authError } = await supabase.auth.getUser()
    if (authError || !user) {
      return NextResponse.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, { status: 401 })
    }

    // ì‚¬ìš©ì ì •ë³´ (GitHub í† í°) ê°€ì ¸ì˜¤ê¸°
    const { data: profile, error: profileError } = await supabase
      .from('users')
      .select('github_token, github_username')
      .eq('id', user.id)
      .single()

    if (profileError || !profile?.github_token) {
      return NextResponse.json({ error: 'GitHub í† í°ì´ ì—†ìŠµë‹ˆë‹¤.' }, { status: 401 })
    }

    // ê³¼ì œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const { data: task, error: taskError } = await supabase
      .from('tasks')
      .select('*, lectures(*)')
      .eq('id', taskId)
      .single()

    if (taskError || !task) {
      return NextResponse.json({ error: 'ê³¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, { status: 404 })
    }

    if (!task.github_repo_url) {
      return NextResponse.json({ error: 'ì—°ê²°ëœ GitHub ë ˆí¬ì§€í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.' }, { status: 400 })
    }

    // ë ˆí¬ ì´ë¦„ ì¶”ì¶œ (ì˜ˆ: https://github.com/username/repo -> repo)
    const repoUrlParts = task.github_repo_url.split('/')
    const repoName = repoUrlParts[repoUrlParts.length - 1]
    const owner = repoUrlParts[repoUrlParts.length - 2]

    // README ë‚´ìš© ìƒì„±
    const readmeContent = generateReadmeContent(task as unknown as Task)

    // ê¸°ì¡´ README íŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (sha í•„ìš”)
    const getFileRes = await fetch(
      `https://api.github.com/repos/${owner}/${repoName}/contents/README.md`,
      {
        headers: {
          'Authorization': `Bearer ${profile.github_token}`,
          'Accept': 'application/vnd.github+json',
          'X-GitHub-Api-Version': '2022-11-28',
        },
      }
    )

    let sha: string | undefined
    if (getFileRes.ok) {
      const fileData = await getFileRes.json()
      sha = fileData.sha
    }

    // README ì—…ë°ì´íŠ¸
    const updateRes = await fetch(
      `https://api.github.com/repos/${owner}/${repoName}/contents/README.md`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${profile.github_token}`,
          'Accept': 'application/vnd.github+json',
          'X-GitHub-Api-Version': '2022-11-28',
        },
        body: JSON.stringify({
          message: 'Update README with task details',
          content: Buffer.from(readmeContent).toString('base64'),
          ...(sha && { sha }),
        }),
      }
    )

    if (!updateRes.ok) {
      const errorData = await updateRes.json()
      console.error('GitHub API error:', errorData)
      return NextResponse.json({ error: 'README ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' }, { status: 500 })
    }

    return NextResponse.json({ success: true })

  } catch (error) {
    console.error('README update error:', error)
    return NextResponse.json({ error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, { status: 500 })
  }
}

function generateReadmeContent(task: Task): string {
  const steps = task.steps || []
  const successCriteria = task.success_criteria || []
  const techStack = task.tech_stack || []

  const difficultyLabel =
    task.difficulty === 'beginner' ? 'ğŸŸ¢ ì´ˆê¸‰' :
    task.difficulty === 'intermediate' ? 'ğŸŸ¡ ì¤‘ê¸‰' :
    'ğŸ”´ ê³ ê¸‰'

  return `# ${task.title}

> Lecpin ì‹¤ìŠµ ê³¼ì œ

## ğŸ“‹ ê³¼ì œ ê°œìš”

${task.description}

### ì™œ ì´ ê³¼ì œì¸ê°€ìš”?

${task.reason}

---

## ğŸ¯ í•™ìŠµ ëª©í‘œ

ì´ ê³¼ì œë¥¼ ì™„ë£Œí•˜ë©´ ë‹¤ìŒì„ í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤:

${successCriteria.map((c: string, i: number) => `${i + 1}. ${c}`).join('\n')}

---

## ğŸ›  ê¸°ìˆ  ìŠ¤íƒ

${techStack.map((t: string) => `- ${t}`).join('\n')}

---

## ğŸ“ êµ¬í˜„ ë‹¨ê³„

${steps.map((step: TaskStep, i: number) => `
### Step ${step.order || i + 1}${step.title ? `: ${step.title}` : ''}

${step.content}
`).join('\n')}

---

## â± ì˜ˆìƒ ì†Œìš” ì‹œê°„

${task.estimated_time}

## ğŸ“Š ë‚œì´ë„

${difficultyLabel}

---

## ğŸš€ ì‹œì‘í•˜ê¸°

1. ì´ ë ˆí¬ì§€í† ë¦¬ë¥¼ í´ë¡ í•©ë‹ˆë‹¤
2. í•„ìš”í•œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤
3. ìœ„ì˜ êµ¬í˜„ ë‹¨ê³„ë¥¼ ë”°ë¼ ì§„í–‰í•©ë‹ˆë‹¤
4. ì™„ë£Œ í›„ Lecpinì—ì„œ ì œì¶œí•©ë‹ˆë‹¤

---

<p align="center">
  <sub>Generated by <a href="https://lecpin.com">Lecpin</a></sub>
</p>
`
}
