import { Task, TaskStep } from '@/types'

// README ë‚´ìš© ìƒì„±
export function generateReadmeContent(task: Task): string {
  const steps = task.steps || []
  const successCriteria = task.success_criteria || []
  const techStack = task.tech_stack || []

  const difficultyLabel =
    task.difficulty === 'beginner' ? 'ğŸŸ¢ ì´ˆê¸‰' :
    task.difficulty === 'intermediate' ? 'ğŸŸ¡ ì¤‘ê¸‰' :
    'ğŸ”´ ê³ ê¸‰'

  return `# ${task.title}

> Lecpin ì‹¤ìŠµ ê³¼ì œ

## ğŸ“‹ ê³¼ì œ ê°œìš”

${task.description}

### ì™œ ì´ ê³¼ì œì¸ê°€ìš”?

${task.reason}

---

## ğŸ¯ í•™ìŠµ ëª©í‘œ

ì´ ê³¼ì œë¥¼ ì™„ë£Œí•˜ë©´ ë‹¤ìŒì„ í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤:

${successCriteria.map((c: string, i: number) => `${i + 1}. ${c}`).join('\n')}

---

## ğŸ›  ê¸°ìˆ  ìŠ¤íƒ

${techStack.map((t: string) => `- ${t}`).join('\n')}

---

## ğŸ“ êµ¬í˜„ ë‹¨ê³„

${steps.map((step: TaskStep, i: number) => `
### Step ${step.order || i + 1}${step.title ? `: ${step.title}` : ''}

${step.content}
`).join('\n')}

---

## â± ì˜ˆìƒ ì†Œìš” ì‹œê°„

${task.estimated_time}

## ğŸ“Š ë‚œì´ë„

${difficultyLabel}

---

## âš ï¸ ì¤‘ìš” ì•ˆë‚´

> **ì½”ë“œ ë¶„ëŸ‰ ì œí•œ**: AI ì½”ë“œ ë¦¬ë·°ì˜ ì •í™•ë„ë¥¼ ìœ„í•´ **í•µì‹¬ íŒŒì¼ 3~5ê°œ, ì´ 300ì¤„ ì´ë‚´**ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
>
> ë„ˆë¬´ ë§ì€ íŒŒì¼ì´ë‚˜ ì½”ë“œë¥¼ ì œì¶œí•˜ë©´ ë¦¬ë·° í’ˆì§ˆì´ ì €í•˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ë³´ë‹¤ **í•µì‹¬ ë¡œì§ êµ¬í˜„**ì— ì§‘ì¤‘í•´ì£¼ì„¸ìš”!

---

## ğŸš€ ì‹œì‘í•˜ê¸°

1. ì´ ë ˆí¬ì§€í† ë¦¬ë¥¼ í´ë¡ í•©ë‹ˆë‹¤
2. í•„ìš”í•œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤
3. ìœ„ì˜ êµ¬í˜„ ë‹¨ê³„ë¥¼ ë”°ë¼ ì§„í–‰í•©ë‹ˆë‹¤
4. ì™„ë£Œ í›„ Lecpinì—ì„œ ì œì¶œí•©ë‹ˆë‹¤

---

<p align="center">
  <sub>Generated by <a href="https://lecpin.com">Lecpin</a></sub>
</p>
`
}

// GitHub ë ˆí¬ì§€í† ë¦¬ README ì—…ë°ì´íŠ¸
export async function updateRepoReadme(params: {
  repoUrl: string
  githubToken: string
  task: Task
}): Promise<{ success: boolean; error?: string }> {
  const { repoUrl, githubToken, task } = params

  try {
    // ë ˆí¬ ì •ë³´ ì¶”ì¶œ (ì˜ˆ: https://github.com/username/repo)
    const repoUrlParts = repoUrl.split('/')
    const repoName = repoUrlParts[repoUrlParts.length - 1]
    const owner = repoUrlParts[repoUrlParts.length - 2]

    // README ë‚´ìš© ìƒì„±
    const readmeContent = generateReadmeContent(task)

    // ê¸°ì¡´ README íŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (sha í•„ìš”)
    const getFileRes = await fetch(
      `https://api.github.com/repos/${owner}/${repoName}/contents/README.md`,
      {
        headers: {
          'Authorization': `Bearer ${githubToken}`,
          'Accept': 'application/vnd.github+json',
          'X-GitHub-Api-Version': '2022-11-28',
        },
      }
    )

    let sha: string | undefined
    if (getFileRes.ok) {
      const fileData = await getFileRes.json()
      sha = fileData.sha
    }

    // README ì—…ë°ì´íŠ¸
    const updateRes = await fetch(
      `https://api.github.com/repos/${owner}/${repoName}/contents/README.md`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${githubToken}`,
          'Accept': 'application/vnd.github+json',
          'X-GitHub-Api-Version': '2022-11-28',
        },
        body: JSON.stringify({
          message: 'docs: Update README with task requirements',
          content: Buffer.from(readmeContent).toString('base64'),
          ...(sha && { sha }),
        }),
      }
    )

    if (!updateRes.ok) {
      const errorData = await updateRes.json()
      console.error('GitHub README update error:', errorData)
      return { success: false, error: 'README ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' }
    }

    return { success: true }
  } catch (error) {
    console.error('README update error:', error)
    return { success: false, error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }
  }
}
